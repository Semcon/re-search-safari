
<!DOCTYPE html>

<head>
    <title>
        Event page
    </title>
</head>

<body>
    <script>

//Safari bug fix
//window.onunload = function(){};
        var doLog = false;


        var currentState = '';
        var currentTerms;
        var currentURL;
        var jsonData;
        var windowRight = false;
        var windowLeft = false;

        var DATA_URL = 'https://api.myjson.com/bins/1rq4a';
        var resizeNextContent = false;
        var height;
        var width;
        var initialWidth = false;
        var wTop;
        var left;
        var tabLeft = false;
        var tabRight = false;

        //Eventlistener variables
        var eventListenerWindowLeft = false;
        var eventListenerWindowRight = false;
        var eventListenerTabLeft = false;
        var eventListenerTabRight = false;




        //First time running script to check what value runState is in chrome storage.
        //If runState is undefined it is gets set to enabled otherwise it gets the value.

        currentState = localStorage.getItem('runState');
        if (doLog) {
            console.log('val: ', currentState);
        }

        if (currentState === 'undefined') {
            currentState = 'enabled';
            localStorage.setItem('runState', currentState);
            if (doLog) {
                console.log('Saved', 'runState', currentState);
            }
        }

        var xhr = new XMLHttpRequest();
        xhr.open('GET', DATA_URL, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                jsonData = JSON.parse(xhr.responseText);
            }
        }
        xhr.send();


        //Close handlers for windows and tabs


       function closeHandlerTabLeft() {
            tabLeft.removeEventListener('close', closeHandlerTabLeft, false);
            eventListenerTabLeft = false;
            tabLeft = false;
        }

        function closeHandlerTabRight(){
            tabRight.removeEventListener('close', closeHandlerTabRight, false);
            eventListenerTabRight = false;
            tabRight = false;
        }

        function closeHandlerWindowLeft(){
            windowLeft.removeEventListener('close', closeHandlerWindowLeft, false);
            eventListenerWindowLeft = false;
            if(windowRight !== false){
                if(typeof windowRight.tabs !== 'undefined'){
                    for(var i = 0; i < windowRight.tabs.length; i++){
                        if(typeof windowRight.tabs[i].url !== 'undefined'){
                            windowRight.tabs[i].page.dispatchMessage('message', {resizeWindow: true, width: initialWidth, height: Math.max(height, 0), left: Math.max(left, 0), top: Math.max(wTop, 0)});
                            windowRight.activate();
                            windowRight.removeEventListener('close', closeHandlerWindowRight, false);
                            eventListenerWindowRight = false;
                            windowRight = false;
                            if(eventListenerTabRight === true){
                                tabRight.removeEventListener('close', closeHandlerTabRight, false);
                                eventListenerTabRight = false;
                                tabRight = false;
                            }
                            break;
                        }
                    }
                }
            }
            else if(windowRight === false){
                initialWidth = false;
            }
        }

        function closeHandlerWindowRight(){
            if(windowLeft !== false){
                if(typeof windowLeft.tabs !== 'undefined'){
                    for(var i = 0; i < windowLeft.tabs.length; i++){
                        if(typeof windowLeft.tabs[i].url !== 'undefined'){
                            windowLeft.tabs[i].page.dispatchMessage('message', {resizeWindow: true, width: initialWidth, height: Math.max(height, 0), left: Math.max(left, 0), top: Math.max(wTop, 0)});
                            windowLeft.activate();
                            windowRight.removeEventListener('close', closeHandlerWindowRight, false);
                            eventListenerWindowRight = false;
                            windowRight = false;
                            break;
                        }
                    }
                }
            }
            else if(windowLeft === false){
                initialWidth = false;
            }
        }


        //Function for opening windows and tabs

        function showWindows(request, newTerm, windowWidth, windowHeight, windowScreenLeft, windowScreenTop, searchOriginWindow) {
            if (doLog) {
                console.log(request.term);
        				console.log('windowWidth sent from content: ',windowWidth);
        				console.log(windowHeight);
                console.log(windowScreenLeft);
                console.log(windowScreenTop);
            }

            width = windowWidth;
            height = windowHeight;
            left = windowScreenLeft;
            wTop = windowScreenTop;
            if(initialWidth === false){
                initialWidth = windowWidth;
            }

            if (currentURL !== 'undefined') {
                var link = currentURL + newTerm;
                var originLink = currentURL + request.term;

                if (doLog) {
                    console.log('Link: ', link);
                }

                if (windowRight === false || typeof windowRight === 'undefined') {
                    resizeNextContent = true;
          					windowRight = safari.application.openBrowserWindow();

                    if(eventListenerWindowRight === false){
                        windowRight.addEventListener('close', closeHandlerWindowRight, false);
                        eventListenerWindowRight = true;
                    }
          					var activeTab = windowRight.tabs[0];
          					activeTab.url = link;
          					tabLeft.page.dispatchMessage("message",{resizeWindow: true, width: Math.max(width/2, 0), height: Math.max(height, 0), left: Math.max(left, 0), top: Math.max(wTop, 0)});
                }
                else {
                    if (doLog) {
                        console.log('Should update alternate window');
                    }

                    if (searchOriginWindow.page === tabRight.page) {
                        if(tabLeft !== false){
                            tabLeft.url = originLink;
                            tabLeft.activate();
                        }
                        else {
                            tabLeft = windowLeft.openTab();
                            if(eventListenerTabLeft === false){
                                tabLeft.addEventListener('close', closeHandlerTabLeft, false);
                                eventListenerTabLeft = true;
                            }
                            tabLeft.url = originLink;
                        }
                    }

                    if(tabRight === false){
                        tabRight = windowRight.openTab();
                        if(eventListenerTabRight === false){
                            tabRight.addEventListener('close', closeHandlerTabRight, false);
                            eventListenerTabRight = true;
                        }
                        tabRight.url = link;
                        tabRight.activate();
                    }
                    else{
                        tabRight.url = link;
                        tabRight.activate();
                    }
                }
            }
            else {
                if (doLog) {
                    console.log('currentURL and/or currentTerms is undefined');
                }
            }
        }

        //Content script calls this function to get information about the search engine.
        //If the website matches any of the required, the terms will be declared and the
        // search field selector will be sent back to the content script

        function getEngineInformation(messageEvent) {
            var request = messageEvent.message;
            //content script is asking for selector
            if(doLog){
                console.log(request);
            }

            var url = request.url;
            var currentEngine;

            // Loop over all engines
            if (typeof jsonData !== 'undefined' && typeof url !== 'undefined') {
                for (var i = 0; i < jsonData.engines.length; i = i + 1) {
                    var matchCount = 0;

                    // Loop over all required matches for the engine
                    for (var matchIndex = 0; matchIndex < jsonData.engines[i].match.length; matchIndex = matchIndex + 1) {
                        if (url.indexOf(jsonData.engines[i].match[matchIndex]) > -1) {
                            // We have a match, increment our counter
                            matchCount = matchCount + 1;
                            if (doLog) {
                                console.log('found match, matchCount: ', matchCount);
                            }
                        }
                    }

                    // If we have the same number of matches as required matches we have a valid site
                    if (matchCount === jsonData.engines[i].match.length) {
                        if (doLog) {
                            console.log('Valid site');
                        }

                        currentEngine = jsonData.engines[i];
                        currentTerms = [];
                        for (var key in jsonData.terms[currentEngine.terms]) {
                            currentTerms.push(jsonData.terms[currentEngine.terms][key]);
                        }

                        currentURL = currentEngine.url;
            						// console.log("english terms");
            						// console.log(jsonData.terms[currentEngine.terms].eng);

                        messageEvent.target.page.dispatchMessage('message', {'selectorSearchField': currentEngine.selectors.input, 'englishTerms': jsonData.terms[currentEngine.terms].eng});
                    }
                }

                if (doLog) {
                    console.log('If not valid site, Url:', url);
                }
            }
        }


        //Message handler for all incoming messages

        safari.application.addEventListener('message', function(MessageEvent) {
            if(doLog){
                console.log('Received action: ', MessageEvent.message.action);
            }

            switch (MessageEvent.message.action) {

                case 'resize':
                    if(resizeNextContent === true){
                        MessageEvent.target.page.dispatchMessage("message", {resizeWindow: true, width: Math.max(width/2, 0), height: Math.max(height, 0), left: Math.max(left + (width/2), 0), top: Math.max(wTop, 0)});
                        resizeNextContent = false;
                    }
                    break;

                case 'getEngineInformation':
					          getEngineInformation(MessageEvent);
                    break;

                case 'searchForTerm':
                    var termStatus = 'term not found';
                    var lowercaseTerms;

                    if(currentState === 'enabled'){
                        if (doLog) {
                            console.log('received term: ', MessageEvent.message.term);
                            console.log('currentTerms: ', currentTerms);
                            console.log('Using term: ', MessageEvent.message.term.toLowerCase());
                        }

                        if(tabLeft === false && tabRight === false){
                            tabLeft = MessageEvent.target;
                            if(eventListenerTabLeft === false){
                                tabLeft.addEventListener('close', closeHandlerTabLeft, false);
                                eventListenerTabLeft = true;
                            }
                            windowLeft = tabLeft.browserWindow;
                            if(eventListenerWindowLeft === false){
                                windowLeft.addEventListener('close', closeHandlerWindowLeft, false);
                                eventListenerWindowLeft = true;
                            }
                        }

                        else if(MessageEvent.target !== tabLeft){
                            tabRight = MessageEvent.target;
                            if(eventListenerTabRight === false){
                                tabRight.addEventListener('close', closeHandlerTabRight, false);
                                eventListenerTabRight = true;
                            }
                        }

                        MessageEvent.message.term = MessageEvent.message.term.toLowerCase();

                        if (currentTerms !== 'undefined') {
                            if (doLog) {
                                console.log('currentTerms is defined');
                            }

                            for (var i = 0; i < currentTerms.length; i++) {
                                lowercaseTerms = Object.keys(currentTerms[i]).map(function(string) {
                                    return string.toLowerCase();
                                });

                                if (lowercaseTerms.indexOf(MessageEvent.message.term) > -1) {
                                    if (doLog) {
                                        console.log('term is found', MessageEvent.message);
                                    }

                                    termStatus = 'term was found';

                                    showWindows(MessageEvent.message, currentTerms[i][Object.keys(currentTerms[i])[lowercaseTerms.indexOf(MessageEvent.message.term)]], MessageEvent.message.windowWidth, MessageEvent.message.windowHeight, MessageEvent.message.windowScreenLeft, MessageEvent.message.windowScreenTop, MessageEvent.target);

                                    break;
                                }
                            }
                        }
                    }
                    break;

                case 'updateTabURL':
                /*    queryOptions.active = true;

                    if (windowRight !== false) {
                        queryOptions.windowId = originWindow.id
                    } else {
                        queryOptions.currentWindow = true;
                    }

                    if (typeof currentURL !== 'undefined') {
                        chrome.tabs.query(queryOptions, function(tabs) {
                            var newURL = currentURL + request.term;
                            chrome.tabs.update(tabs[0].id, {
                                url: newURL
                            });
                        });
                    }*/
                    break;


                default:
                    if (doLog) {
                        console.log('Message to event page was not handled: ', MessageEvent.message);
                    }
            }

            return true;
        }, false);
    </script>
</body>
