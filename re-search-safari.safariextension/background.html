
<!DOCTYPE html>

<head>
    <title>
        Event page
    </title>
</head>

<body>
    <script>


    var doLog = true;

    var currentTerms;
    var currentURL;
    var jsonData;
    var windowRight = false;
    var windowLeft = false;

    var DATA_URL = 'https://api.myjson.com/bins/1rq4a';
    var TIP_URL = 'http://example.com';

    var resizeNextContent = false;
    var height;
    var width;
    var initialWidth = false;
    var wTop;
    var left;
    var tabLeft = false;
    var tabRight = false;

    //Eventlistener variables
    var eventListenerWindowLeft = false;
    var eventListenerWindowRight = false;
    var eventListenerTabLeft = false;
    var eventListenerTabRight = false;

    var showPopups = true;
    var showBar = true;
    var latestTerm = false;


    //First time running script to check what value runState is in chrome storage.
    //If runState is undefined it is gets set to enabled otherwise it gets the value.

    showPopups = localStorage.getItem('runState');

    if( typeof showPopups === 'undefined' || showPopups === null ){
        showPopups = true;
        localStorage.setItem('runState', showPopups);
    }

    showBar = localStorage.getItem('showBar');

    if( typeof showBar === 'undefined' || showBar === null ){
        showBar = true;
        localStorage.setItem('showBar', showBar);
    }


    //Close handlers for windows and tabs

    function closeHandlerTabLeft() {
        tabLeft.removeEventListener('close', closeHandlerTabLeft, false);
        eventListenerTabLeft = false;
        tabLeft = false;
    }

    function closeHandlerTabRight(){
        tabRight.removeEventListener('close', closeHandlerTabRight, false);
        eventListenerTabRight = false;
        tabRight = false;
    }

    function closeHandlerWindowLeft(){
        windowLeft.removeEventListener('close', closeHandlerWindowLeft, false);
        eventListenerWindowLeft = false;
        if(windowRight !== false){
            if(typeof windowRight.tabs !== 'undefined'){
                for(var i = 0; i < windowRight.tabs.length; i++){
                    if(typeof windowRight.tabs[i].url !== 'undefined'){
                        windowRight.tabs[i].page.dispatchMessage('message', {
                            resizeWindow: true,
                            width: initialWidth,
                            height: Math.max(height, 0),
                            left: Math.max(left, 0),
                            top: Math.max(wTop, 0)
                        });
                        windowRight.activate();
                        windowRight.removeEventListener('close', closeHandlerWindowRight, false);
                        eventListenerWindowRight = false;
                        windowRight = false;
                        if(eventListenerTabRight){
                            tabRight.removeEventListener('close', closeHandlerTabRight, false);
                            eventListenerTabRight = false;
                            tabRight = false;
                        }
                        break;
                    }
                }
            }
        }
        else if(!windowRight){
            initialWidth = false;
        }
    }

    function closeHandlerWindowRight(){
        if(windowLeft !== false){
            if(typeof windowLeft.tabs !== 'undefined'){
                for(var i = 0; i < windowLeft.tabs.length; i++){
                    if(typeof windowLeft.tabs[i].url !== 'undefined'){
                        console.log('INITIAL WIDTH: ', initialWidth);
                        windowLeft.tabs[i].page.dispatchMessage('message', {
                            resizeWindow: true,
                            width: initialWidth,
                            height: Math.max(height, 0),
                            left: Math.max(left, 0),
                            top: Math.max(wTop, 0)
                        });
                        windowLeft.activate();
                        windowRight.removeEventListener('close', closeHandlerWindowRight, false);
                        eventListenerWindowRight = false;
                        windowRight = false;
                        break;
                    }
                }
            }
        }
        else if(!windowLeft){
            initialWidth = false;
        }
    }


    var xhr = new XMLHttpRequest();
    xhr.open('GET', DATA_URL, true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
            jsonData = JSON.parse(xhr.responseText);
        }
    }
    xhr.send();


    function sendTip(){
        var xhr = new XMLHttpRequest();
        xhr.open( 'POST', TIP_URL, true );
        xhr.setRequestHeader( 'Content-Type', 'application/x-www-form-urlencoded' );
        xhr.onreadystatechange = function() {
            if ( xhr.readyState === 4 && xhr.status === 200 ) {
                console.log( 'Tip sent' );
            }
        }
        xhr.send( 'term=' + latestTerm );
    }


    //Function for opening windows and tabs

    function showWindows(term, newTerm, windowWidth, windowHeight, windowScreenLeft, windowScreenTop, searchOriginWindow) {
        if(typeof currentURL === 'undefined'){
            return false;
        }

        if(!showPopups){
            return false;
        }

        if (doLog) {
            console.log(term);
            console.log('windowWidth sent from content: ',windowWidth);
            console.log(windowHeight);
            console.log(windowScreenLeft);
            console.log(windowScreenTop);
        }

        width = windowWidth;
        height = windowHeight;
        left = windowScreenLeft;
        wTop = windowScreenTop;

        if(!initialWidth){
            initialWidth = windowWidth;
            console.log('SETTING INITIAL WIDTH: ', initialWidth);
        }

        var link = currentURL + newTerm;
        var originLink = currentURL + term;

        if (doLog) {
            console.log('Link: ', link);
        }

        if (!windowRight || typeof windowRight === 'undefined') {
            resizeNextContent = true;
            windowRight = safari.application.openBrowserWindow();

            if(!eventListenerWindowRight){
                windowRight.addEventListener('close', closeHandlerWindowRight, false);
                eventListenerWindowRight = true;
            }

            console.log('setting tabRight');
            tabRight = windowRight.tabs[0];
            if(!eventListenerTabRight){
                tabRight.addEventListener('close', closeHandlerTabRight, false);
                eventListenerTabRight;
            }
            tabRight.url = link;
            tabRight.activate();

            tabLeft.page.dispatchMessage("message",{
                resizeWindow: true,
                width: Math.max(width/2, 0),
                height: Math.max(height, 0),
                left: Math.max(left, 0),
                top: Math.max(wTop, 0)});
        }
        else {
            if (doLog) {
                console.log('Should update alternate window');
            }

            if (searchOriginWindow.page === tabRight.page) {
                if(tabLeft !== false){
                    tabLeft.url = originLink;
                    tabLeft.activate();
                }
                else {
                    tabLeft = windowLeft.openTab();
                    if(!eventListenerTabLeft){
                        tabLeft.addEventListener('close', closeHandlerTabLeft, false);
                        eventListenerTabLeft = true;
                    }
                    tabLeft.url = originLink;
                }
            }
            if(!tabRight){
                console.log('in showWindows - tab right was false, opening new tab..')
                tabRight = windowRight.openTab();
                if(!eventListenerTabRight){
                    tabRight.addEventListener('close', closeHandlerTabRight, false);
                    eventListenerTabRight = true;
                }
                tabRight.url = link;
                tabRight.activate();
            }
            else{
                tabRight.url = link;
                tabRight.activate();
            }
        }
    }


    function runToolbarScript(){
        if( !currentURL ){
            return false;
        }
        var whiteList = [];
        var blackList = [];
        whiteList[0] = 'http://www.google.se';
        // if( tabLeft !== false ){
            var URI = safari.extension.addContentStyleSheetFromURL(
                safari.extension.baseURI + 'toolbar.css',
                whiteList,
                blackList
            );
            console.log(URI);
        // }
        // if( tabRight !== false ){
            // var URI = safari.extension.addContentStyleSheetFromURL(
            //     safari.extension.baseURI + 'toolbar.css',
            //     whiteList,
            //     blackList
            // );
            // console.log(URI);
        // }
        // if( !tabLeft && !tabRight ){
            // var URI = safari.extension.addContentStyleSheetFromURL(
            //     safari.extension.baseURI + 'toolbar.css',
            //     whiteList,
            //     blackList
            // );
            // console.log(URI);
        // }
    }





    function hasBetterTerm( term ){
        var lowercaseTerms;
        if( typeof currentTerms === 'undefined' ){
            return false;
        }
        term = term.toLowerCase();
        for(var i = 0; i < currentTerms.length; i++ ){
            lowercaseTerms = Object.keys( currentTerms[ i ] ).map( function( string ){
                return string.toLowerCase();
            });
            if( lowercaseTerms.indexOf( term ) > -1 ){
                return currentTerms[ i ][ Object.keys( currentTerms[ i ] )[ lowercaseTerms.indexOf( term ) ] ];
            }
        }
        return false;
    }


    function getEngine( url ){
        if( typeof jsonData === 'undefined' ) {
            return false;
        }
        if( typeof url === 'undefined' ){
            return false;
        }
        for( var i = 0; i < jsonData.engines.length; i = i + 1 ){
            var matchCount = 0;
            // Loop over all required matches for the engine
            for( var matchIndex = 0; matchIndex < jsonData.engines[ i ].match.length; matchIndex = matchIndex + 1 ){
                if( url.indexOf( jsonData.engines[ i ].match[ matchIndex ] ) > -1 ){
                    // We have a match, increment our counter
                    matchCount = matchCount + 1;
                }
            }
            // If we have the same number of matches as required matches we have a valid site
            if( matchCount === jsonData.engines[ i ].match.length ){
                return jsonData.engines[ i ];
            }
        }
        return false;
    }


    function isValidUrl( url ){
        if( !getEngine( url ) ){
            return false;
        }
        return true;
    }


    //Content script calls this function to get information about the search engine.
    //If the website matches any of the required, the terms will be declared and the
    // search field selector will be sent back to the content script

    function getEngineInformation(messageEvent) {
        var currentEngine = getEngine( messageEvent.message.url );


        if(!currentEngine){
            return false;
        }

        currentTerms = [];
        for ( var key in jsonData.terms[ currentEngine.terms ] ){
            currentTerms.push( jsonData.terms[ currentEngine.terms ][ key ] );
        }
        currentURL = currentEngine.url;
        englishTerms = jsonData.terms[ currentEngine.terms ].eng;
        console.log('going to run toolbar script');
        runToolbarScript();

        messageEvent.target.page.dispatchMessage('message', {
            selectorSearchField: currentEngine.selectors.input
        });

        return true;
    }


    function enableToolbar(){
        console.log('ENABLING TOOLBAR!!!!!!!');
        showBar = true;
        localStorage.setItem('showBar', showBar);
        runToolbarScript();
    }

    //Message handler for all incoming messages

    safari.application.addEventListener('message', function(MessageEvent) {
        if(doLog){
            console.log('Received action: ', MessageEvent.message.action);
        }

        var betterTerm = false;

        switch (MessageEvent.message.action) {

            case 'resize':
                if(resizeNextContent){
                    MessageEvent.target.page.dispatchMessage("message", {
                        resizeWindow: true,
                        width: Math.max(width/2, 0),
                        height: Math.max(height, 0),
                        left: Math.max(left + (width/2), 0),
                        top: Math.max(wTop, 0)
                    });
                    resizeNextContent = false;
                }
                break;

            case 'getEngineInformation':
                getEngineInformation(MessageEvent);
                break;

            case 'searchForTerm':
                latestTerm = MessageEvent.message.term;
                betterTerm = hasBetterTerm(MessageEvent.message.term);

                if(betterTerm){
                    if (doLog) {
                        console.log('received term: ', MessageEvent.message.term);
                        console.log('currentTerms: ', currentTerms);
                        console.log('Using term: ', MessageEvent.message.term.toLowerCase());
                    }

                    if(!tabLeft && !tabRight){
                        console.log('tableft and tabright are false')
                        tabLeft = MessageEvent.target;
                        if(!eventListenerTabLeft){
                            tabLeft.addEventListener('close', closeHandlerTabLeft, false);
                            eventListenerTabLeft = true;
                        }
                        windowLeft = tabLeft.browserWindow;
                        if(!eventListenerWindowLeft){
                            windowLeft.addEventListener('close', closeHandlerWindowLeft, false);
                            eventListenerWindowLeft = true;
                        }
                    }

                    else if(MessageEvent.target !== tabLeft){
                        console.log('search was made from right window')
                        tabRight = MessageEvent.target;
                        if(!eventListenerTabRight){
                            tabRight.addEventListener('close', closeHandlerTabRight, false);
                            eventListenerTabRight = true;
                        }
                    }
                    showWindows(MessageEvent.message.term, betterTerm, MessageEvent.message.windowWidth, MessageEvent.message.windowHeight, MessageEvent.message.windowScreenLeft, MessageEvent.message.windowScreenTop, MessageEvent.target);
                }

                break;

            case 'updateTabURL':

                if(typeof currentURL !== 'undefined'){
                    var newURL = currentURL + MessageEvent.message.term;
                    if(tabLeft !== false){
                        tabLeft.url = newURL;
                        tabLeft.activate();
                    }
                    else if(!windowRight){
                        MessageEvent.target.url = newURL;
                        MessageEvent.target.activate();
                    }
                    else{
                        tabLeft = windowLeft.openTab();
                        if(!eventListenerTabLeft){
                            tabLeft.addEventListener('close', closeHandlerTabLeft, false);
                            eventListenerTabLeft = true;
                        }
                        tabLeft.url = newURL;
                        tabLeft.activate();
                    }
                }
                break;

            case 'getRunState':
                MessageEvent.target.page.dispatchMessage("message", {
                    runState: showPopups
                });
                break;

            case 'disablePopups':
                showPopups = false;

                localStorage.setItem('runState', showPopups);

                if(tabLeft !== false){
                    tabLeft.page.dispatchMessage('message', {
                        action: 'stateChanged',
                        runState: showPopups
                    });
                }

                if(tabRight !== false){
                    tabRight.page.dispatchMessage('message', {
                        action: 'stateChanged',
                        runState: showPopups
                    });
                }

                if(MessageEvent.target.page !== tabLeft && MessageEvent.target.page !== tabRight){
                    MessageEvent.target.page.dispatchMessage('message', {
                        action: 'stateChanged',
                        runState: showPopups
                    });
                }

                break;

            case 'enablePopups':
                showPopups = true;

                localStorage.setItem('runState', showPopups);

                if(tabLeft !== false){
                    tabLeft.page.dispatchMessage('message', {
                        action: 'stateChanged',
                        runState: showPopups
                    });
                }

                if(tabRight !== false){
                    tabRight.page.dispatchMessage('message', {
                        action: 'stateChanged',
                        runState: showPopups
                    });
                }

                if(MessageEvent.target.page !== tabLeft && MessageEvent.target.page !== tabRight){
                    MessageEvent.target.page.dispatchMessage('message', {
                        action: 'stateChanged',
                        runState: showPopups
                    });
                }

                break;

            case 'getEnglishTerms':
                MessageEvent.target.page.dispatchMessage('message', {
                    englishTerms: englishTerms
                });


            case 'isValidUrl':
                if( isValidUrl(MessageEvent.message.url) ){
                    MessageEvent.target.page.dispatchMessage('message', {
                        valid: true
                    });

                } else {
                    MessageEvent.target.page.dispatchMessage('message', {
                        valid: false
                    });
                }
                break;


            case 'getLatestTerm':
                MessageEvent.target.page.dispatchMessage('message', {
                    latestTerm: latestTerm
                });
                break;

            case 'sendTip':
                sendTip();
                break;

            case 'addToolbar':
                runToolbarScript();
                break;

            case 'getToolbarStatus':
                console.log('showBar: ', showBar);
                if(typeof MessageEvent.target.page !== 'undefined'){
                    MessageEvent.target.page.dispatchMessage('message', {
                        showBar: showBar
                    });
                }
                break;

            // case 'enableToolbar':
            //     showBar = true;
            //     localStorage.setItem('showBar', showBar);
            //     runToolbarScript();
            //     break;

            case 'disableToolbar':
                showBar = false;
                localStorage.setItem('showBar', showBar);
                runToolbarScript();
                break;

            default:
                if (doLog) {
                    console.log('Message to event page was not handled: ', MessageEvent.message);
                }
        }
        return true;
    }, false);
</script>
</body>
