
<!DOCTYPE html>

<head>
    <title>
        Event page
    </title>
</head>

<body>
    <script>

//Safari bug fix
//window.onunload = function(){};

        var currentState = '';
        var currentTerms;
        var currentURL;
        var jsonData;
        var doLog = true;
        var alternateWindow = false;
        var originWindow = false;

        var DATA_URL = 'https://api.myjson.com/bins/1rq4a';
        var temp;
		
		
		
        //First time running script to check what value runState is in chrome storage.
        //If runState is undefined it is gets set to enabled otherwise it gets the value.

        localStorage.setItem('runState', temp);

        currentState = localStorage.getItem('runState');
        if (doLog) {
            console.log('val: ', currentState);
        }

        if (currentState === 'undefined') {
            currentState = 'enabled';
            localStorage.setItem('runState', currentState);
            if (doLog) {
                console.log('Saved', 'runState', currentState);
            }
        }


        function closeHandler(windowId) {
            if (doLog) {
                console.log('Window removed', windowId);
            }

            if (windowId === alternateWindow.id) {
                chrome.windows.update(originWindow.id, {
                    left: originWindow.left,
                    top: originWindow.top,
                    width: originWindow.width,
                    height: originWindow.height,
                    focused: originWindow.focused
                });

                alternateWindow = false;
            } else if (windowId = originWindow.id && alternateWindow.id) {
                chrome.windows.update(alternateWindow.id, {
                    left: originWindow.left,
                    top: originWindow.top,
                    width: originWindow.width,
                    height: originWindow.height,
                    focused: originWindow.focused
                });

                alternateWindow = false;
            }
        }

        safari.application.addEventListener("close", closeHandler, true);

        var xhr = new XMLHttpRequest();
        xhr.open('GET', DATA_URL, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                jsonData = JSON.parse(xhr.responseText);
            }
        }
        xhr.send();

        function showWindows(request, newTerm, windowObject) {
			console.log("inne i showwindows");
            if (doLog) {
                console.log(request.term);
            }

            if (currentURL !== 'undefined') {
                var link = currentURL + newTerm;
                var originLink = currentURL + request.term;

                if (doLog) {
                    console.log('Link: ', link);
                }
				console.log("alternatewindow",alternateWindow);
                if (alternateWindow === false) {
					
					
					
					
					
					
					var window = safari.application.activeBrowserWindow;
					
                  

                        originWindow = window;
						console.log("har e originwindow brooor!")
						console.log(originWindow);
                        safari.application.openBrowserWindow({
                            height: parseInt(window.height, 10),
                            left: parseInt(window.left + (window.width / 2), 10),
                            state: 'normal',
                            top: parseInt(window.top, 10),
                            type: 'normal',
                            url: link,
                            width: parseInt(window.width / 2, 10)
                        }, function(createdWindowData) {
                            alternateWindow = createdWindowData;
                        });

                        chrome.windows.update(window.id, {
                            left: parseInt(window.left, 10),
                            state: 'normal',
                            top: parseInt(window.top, 10),
                            width: parseInt(window.width / 2, 10)
                        });

                } else {
                    if (doLog) {
                        console.log('Should update alternate window');
                    }

                    if (windowObject === alternateWindow) {
                        chrome.tabs.query({
                            active: true,
                            windowId: originWindow.id
                        }, function(tabs) {
                            chrome.tabs.update(tabs[0].id, {
                                url: originLink
                            });
                        });
                    }

                    chrome.tabs.update(alternateWindow.tabs[0].id, {
                        url: link
                    });
                }
            } else {
                if (doLog) {
                    console.log('currentURL and/or currentTerms is undefined');
                }
            }
        }

        function getEngineInformation(request) {
            //content script is asking for selector
			console.log(request);
            var url = request.url;
            var currentEngine;

            // Loop over all engines
            if (typeof jsonData !== 'undefined' && typeof url !== 'undefined') {
                for (var i = 0; i < jsonData.engines.length; i = i + 1) {
                    var matchCount = 0;

                    // Loop over all required matches for the engine
                    for (var matchIndex = 0; matchIndex < jsonData.engines[i].match.length; matchIndex = matchIndex + 1) {
                        if (url.indexOf(jsonData.engines[i].match[matchIndex]) > -1) {
                            // We have a match, increment our counter
                            matchCount = matchCount + 1;
                            if (doLog) {
                                console.log('found match, matchCount: ', matchCount);
                            }
                        }
                    }

                    // If we have the same number of matches as required matches we have a valid site
                    if (matchCount === jsonData.engines[i].match.length) {
                        if (doLog) {
                            console.log('Valid site');
                        }

                        currentEngine = jsonData.engines[i];
                        currentTerms = [];
                        for (var key in jsonData.terms[currentEngine.terms]) {
                            currentTerms.push(jsonData.terms[currentEngine.terms][key]);
                        }

                        currentURL = currentEngine.url;
						console.log("english terms");
						console.log(jsonData.terms[currentEngine.terms].eng);

                        return {selectorSearchField: currentEngine.selectors.input, englishTerms: jsonData.terms[currentEngine.terms].eng}
                    }
                }

                if (doLog) {
                    console.log('If not valid site, Url:', url);
                }
               return {
                    selectorSearchField: false
                }
            }
        }


        

        safari.application.addEventListener('message', function(MessageEvent) {
            console.log("received msg");
			console.log(MessageEvent.target.browserWindow);

            var queryOptions = {};
            console.log(MessageEvent.message.action);
            switch (MessageEvent.message.action) {

                case 'getEngineInformation':
					//MessageEvent.target.page.dispatchMessage("getEngineInformation", getEngineInformation(MessageEvent.message));
					MessageEvent.target.page.dispatchMessage("getEngineInformation", getEngineInformation(MessageEvent.message));
                    break;

                case 'searchForTerm':
                    var termStatus = 'term not found';
                    var lowercaseTerms;

                    if (doLog) {
                        console.log('received term: ', MessageEvent.message.term);
                        console.log('currentTerms: ', currentTerms);
                        console.log('Using term: ', MessageEvent.message.term.toLowerCase());
                    }

                    MessageEvent.message.term = MessageEvent.message.term.toLowerCase();

                    if (currentTerms !== 'undefined') {
                        if (doLog) {
                            console.log('currentTerms is defined');
                        }

                        for (var i = 0; i < currentTerms.length; i++) {
                            console.log(currentTerms[i]);
                            lowercaseTerms = Object.keys(currentTerms[i]).map(function(string) {
                                return string.toLowerCase();
                            });

                            if (lowercaseTerms.indexOf(MessageEvent.message.term) > -1) {
                                if (doLog) {
                                    console.log('term is found', MessageEvent.message);
                                }

                                termStatus = 'term was found';

                                showWindows(MessageEvent.message, currentTerms[i][Object.keys(currentTerms[i])[lowercaseTerms.indexOf(MessageEvent.message.term)]], MessageEvent.target.browserWindow);

                                break;
                            }
                        }
//ToDo ändra här till return
                        return {status: termStatus}
                    }
                    break;

                case 'updateTabURL':
                    queryOptions.active = true;

                    if (alternateWindow !== false) {
                        queryOptions.windowId = originWindow.id
                    } else {
                        queryOptions.currentWindow = true;
                    }

                    if (typeof currentURL !== 'undefined') {
                        chrome.tabs.query(queryOptions, function(tabs) {
                            var newURL = currentURL + request.term;
                            chrome.tabs.update(tabs[0].id, {
                                url: newURL
                            });
                        });
                    }
                    break;

                case 'getRunState':
//                    safari.self.tabs[0].page.dispatchMessage("onGetRunState", {runState: currentState});
                    MessageEvent.target.page.dispatchMessage("message",{runState: currentState});
					console.log(currentState);
                    break;

                case 'changeRunState':
                    if (doLog) {
                        console.log('ChangeRunState from popup / current value is: ', currentState);
                    }

                    if (currentState === 'enabled') {
                        currentState = 'disabled';
                    } else {
                        currentState = 'enabled';
                    }

                    localStorage.setItem('runState', {
                            runState: currentState
                        },
                        function() {
                            if (doLog) {
                                console.log('Saved', 'runState', currentState);
                            }

                            chrome.tabs.query({
                                active: true,
                                currentWindow: true
                            }, function(tabs) {
                                safari.self.tabs[0].page.dispatchMessage("message", {
                                    action: 'changeRunState',
                                    runState: currentState
                                }, function(response) {
                                    if (response) {
                                        if (doLog) {
                                            console.log(response.message);
                                        }
                                    } else {
                                        if (doLog) {
                                            console.log('Content script not injected');
                                        }
                                    }
                                });
                            });

                            sendResponse({
                                runState: currentState
                            });
                        }
                    );
                    break;

                default:
                    if (doLog) {
                        console.log('Message to event page was not handled: ', request);
                    }
            }

            return true;
        }, false);
    </script>
</body>