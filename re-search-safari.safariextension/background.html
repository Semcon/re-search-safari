
<!DOCTYPE html>

<head>
    <title>
        Event page
    </title>
</head>

<body>
    <script>

//Safari bug fix
//window.onunload = function(){};

        var currentState = '';
        var currentTerms;
        var currentURL;
        var jsonData;
        var doLog = true;
        var windowRight = false;
        var windowLeft = false;

        var DATA_URL = 'https://api.myjson.com/bins/1rq4a';
        var resizeNextContent = false;
        var height;
        var width;
        var wTop;
        var left;
        var tabLeft = false;
        var tabRight = false;

        //Eventlistener variables
        var eventListenerWindowLeft = false;
        var eventListenerWindowRight = false;
        var eventListenerTabLeft = false;
        var eventListenerTabRight = false;




        //First time running script to check what value runState is in chrome storage.
        //If runState is undefined it is gets set to enabled otherwise it gets the value.

        currentState = localStorage.getItem('runState');
        if (doLog) {
            console.log('val: ', currentState);
        }

        if (currentState === 'undefined') {
            currentState = 'enabled';
            localStorage.setItem('runState', currentState);
            if (doLog) {
                console.log('Saved', 'runState', currentState);
            }
        }

        var xhr = new XMLHttpRequest();
        xhr.open('GET', DATA_URL, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                jsonData = JSON.parse(xhr.responseText);
            }
        }
        xhr.send();


        //Close handlers for windows and tabs

       function closeHandlerTabLeft() {
            console.log('LEFT TAB WAS CLOSED');
            tabLeft.removeEventListener('close', closeHandlerTabLeft, true);
            eventListenerTabLeft = false;
            console.log('REMOVED LISTENER TAB LEFT');
            tabLeft = false;
        }

        function closeHandlerTabRight(){
            console.log('RIGHT TAB WAS CLOSED');
            tabRight.removeEventListener('close', closeHandlerTabRight, true);
            eventListenerTabRight = false;
            console.log('REMOVED LISTENER TAB RIGHT');
            tabRight = false;
        }

        function closeHandlerWindowLeft(){
            console.log('LEFT WINDOW WAS CLOSED');
            windowLeft.removeEventListener('close', closeHandlerWindowLeft, true);
            eventListenerWindowLeft = false;
            console.log('REMOVED LISTENER WINDOW LEFT');

            console.log('WINDOW RIGHT IS: ' , windowRight);
            if(windowRight !== false){
                if(typeof windowRight.tabs !== 'undefined'){
                    console.log('windowRight is not false, sending resizeWindow');
                    for(var i = 0; i < windowRight.tabs.length; i++){
                        if(typeof windowRight.tabs[i].url !== 'undefined'){
                            console.log('tab was found', windowRight.tabs[i]);
                            windowRight.tabs[i].page.dispatchMessage('message', {resizeWindow: true, width: Math.max(width, 0), height: Math.max(height, 0), left: Math.max(left, 0), top: Math.max(wTop, 0)});
                            windowRight.activate();
                            windowRight.removeEventListener('close', closeHandlerWindowRight, true);
                            console.log('REMOVED LISTENER WINDOW RIGHT');
                            eventListenerWindowRight = false;
                            windowRight = false;
                            if(eventListenerTabRight === true){
                                tabRight.removeEventListener('close', closeHandlerTabRight, true);
                                console.log('REMOVED LISTENER TAB RIGHT');
                                eventListenerTabRight = false;
                                tabRight = false;
                            }
                            break;
                        }
                    }
                }
            }
        }

        function closeHandlerWindowRight(){
            console.log('RIGHT WINDOW WAS CLOSED');
            if(windowLeft !== false){
                if(typeof windowLeft.tabs !== 'undefined'){
                    console.log('sending resize to window left')
                    for(var i = 0; i < windowLeft.tabs.length; i++){
                        console.log('tab: ', windowLeft.tabs[i].url);
                        if(typeof windowLeft.tabs[i].url !== 'undefined'){
                            console.log('tab was found', windowLeft.tabs[i]);
                            windowLeft.tabs[i].page.dispatchMessage('message', {resizeWindow: true, width: Math.max(width, 0), height: Math.max(height, 0), left: Math.max(left, 0), top: Math.max(wTop, 0)});
                            windowLeft.activate();
                            windowRight.removeEventListener('close', closeHandlerWindowRight, true);
                            console.log('REMOVED LISTENER WINDOW RIGHT');
                            eventListenerWindowRight = false;
                            windowRight = false;
                            break;
                        }
                    }
                }
            }
            else{
                console.log('window left is false, resize failed');

            }
        }


        //Function for opening windows and tabs

        function showWindows(request, newTerm, windowWidth, windowHeight, windowScreenLeft, windowScreenTop, searchOriginWindow) {
            if (doLog) {
                console.log(request.term);
        				console.log(windowWidth);
        				console.log(windowHeight);
                console.log(windowScreenLeft);
                console.log(windowScreenTop);
            }

            width = windowWidth;
            height = windowHeight;
            left = windowScreenLeft;
            wTop = windowScreenTop;

            if (currentURL !== 'undefined') {
                var link = currentURL + newTerm;
                var originLink = currentURL + request.term;

                if (doLog) {
                    console.log('Link: ', link);
                }

                if (windowRight === false) {
                    resizeNextContent = true;
          					windowRight = safari.application.openBrowserWindow();

                    if(eventListenerWindowRight === false){
                        windowRight.addEventListener('close', closeHandlerWindowRight, true);
                        console.log('ADDED LISTENER TO WINDOW RIGHT');
                        eventListenerWindowRight = true;
                    }
          					var activeTab = windowRight.tabs[0];
          					activeTab.url = link;
          					tabLeft.page.dispatchMessage("message",{resizeWindow: true, width: Math.max(width/2, 0), height: Math.max(height, 0), left: Math.max(left, 0), top: Math.max(wTop, 0)});
                    console.log('SENT MESSAGE TO TAB LEFT TO RESIZE');
                }
                else {
                    if (doLog) {
                        console.log('Should update alternate window');
                    }

                    if (searchOriginWindow.page === tabRight.page) {
                        if(tabLeft !== false){
                            tabLeft.url = originLink;
                            tabLeft.activate();
                        }
                        else {
                            tabLeft = windowLeft.openTab();
                            if(eventListenerTabLeft === false){
                                tabLeft.addEventListener('close', closeHandlerTabLeft, true);
                                console.log('ADDED LISTENER TAB LEFT');
                                eventListenerTabLeft = true;
                            }
                            tabLeft.url = originLink;
                        }
                    }

                    if(tabRight === false){
                        tabRight = windowRight.openTab();
                        if(eventListenerTabRight === false){
                            tabRight.addEventListener('close', closeHandlerTabRight, true);
                            eventListenerTabRight = true;
                            console.log('ADDED LISTENER TAB RIGHT');
                        }
                        tabRight.url = link;
                        tabRight.activate();
                    }
                    else{
                        tabRight.url = link;
                        tabRight.activate();
                    }
                }
            }
            else {
                if (doLog) {
                    console.log('currentURL and/or currentTerms is undefined');
                }
            }
        }

        //Content script calls this function to get information about the search engine.
        //If the website matches any of the required, the terms will be declared and the
        // search field selector will be sent back to the content script

        function getEngineInformation(messageEvent) {
            var request = messageEvent.message;
            //content script is asking for selector
			      console.log(request);
            var url = request.url;
            var currentEngine;

            // Loop over all engines
            if (typeof jsonData !== 'undefined' && typeof url !== 'undefined') {
                for (var i = 0; i < jsonData.engines.length; i = i + 1) {
                    var matchCount = 0;

                    // Loop over all required matches for the engine
                    for (var matchIndex = 0; matchIndex < jsonData.engines[i].match.length; matchIndex = matchIndex + 1) {
                        if (url.indexOf(jsonData.engines[i].match[matchIndex]) > -1) {
                            // We have a match, increment our counter
                            matchCount = matchCount + 1;
                            if (doLog) {
                                console.log('found match, matchCount: ', matchCount);
                            }
                        }
                    }

                    // If we have the same number of matches as required matches we have a valid site
                    if (matchCount === jsonData.engines[i].match.length) {
                        if (doLog) {
                            console.log('Valid site');
                        }

                        currentEngine = jsonData.engines[i];
                        currentTerms = [];
                        for (var key in jsonData.terms[currentEngine.terms]) {
                            currentTerms.push(jsonData.terms[currentEngine.terms][key]);
                        }

                        currentURL = currentEngine.url;
            						// console.log("english terms");
            						// console.log(jsonData.terms[currentEngine.terms].eng);

                        messageEvent.target.page.dispatchMessage('message', {'selectorSearchField': currentEngine.selectors.input, 'englishTerms': jsonData.terms[currentEngine.terms].eng});
                    }
                }

                if (doLog) {
                    console.log('If not valid site, Url:', url);
                }
            }
        }


        //Message handler for all incoming messages

        safari.application.addEventListener('message', function(MessageEvent) {
            console.log("received msg");
			      console.log(MessageEvent.target.browserWindow);

            var queryOptions = {};
            console.log(MessageEvent.message.action);
            switch (MessageEvent.message.action) {

                case 'resize':
                    if(resizeNextContent === true){
                        MessageEvent.target.page.dispatchMessage("message", {resizeWindow: true, width: Math.max(width/2, 0), height: Math.max(height, 0), left: Math.max(left + (width/2), 0), top: Math.max(wTop, 0)});
                        resizeNextContent = false;
                    }
                    break;

                case 'getEngineInformation':
					          getEngineInformation(MessageEvent);
                    break;

                case 'searchForTerm':
                    var termStatus = 'term not found';
                    var lowercaseTerms;

                    if(currentState === 'enabled'){
                        if (doLog) {
                            console.log('received term: ', MessageEvent.message.term);
                            console.log('currentTerms: ', currentTerms);
                            console.log('Using term: ', MessageEvent.message.term.toLowerCase());
                        }


                        if(tabLeft === false){
                            console.log('SETTING WINDOW LEFT TO tabLeft.browserWindow');
                            tabLeft = MessageEvent.target;
                            if(eventListenerTabLeft === false){
                                tabLeft.addEventListener('close', closeHandlerTabLeft, true);
                                eventListenerTabLeft = true;
                                console.log('ADDED LISTENER TAB LEFT');
                            }
                            windowLeft = tabLeft.browserWindow;
                            if(eventListenerWindowLeft === false){
                                windowLeft.addEventListener('close', closeHandlerWindowLeft, true);
                                eventListenerWindowLeft = true;
                                console.log('ADDED LISTENER WINDOW LEFT');
                            }
                        }

                        else if(MessageEvent.target !== tabLeft){
                            console.log('search was made from right window');
                            tabRight = MessageEvent.target;
                            if(eventListenerTabRight === false){
                                tabRight.addEventListener('close', closeHandlerTabRight, true);
                                eventListenerTabRight = true;
                                console.log('ADDED LISTENER TAB RIGHT');
                            }
                        }

                        MessageEvent.message.term = MessageEvent.message.term.toLowerCase();

                        if (currentTerms !== 'undefined') {
                            if (doLog) {
                                console.log('currentTerms is defined');
                            }

                            for (var i = 0; i < currentTerms.length; i++) {
                                // console.log(currentTerms[i]);
                                lowercaseTerms = Object.keys(currentTerms[i]).map(function(string) {
                                    return string.toLowerCase();
                                });

                                if (lowercaseTerms.indexOf(MessageEvent.message.term) > -1) {
                                    if (doLog) {
                                        console.log('term is found', MessageEvent.message);
                                    }

                                    termStatus = 'term was found';
                                    console.log('3, WINDOW RIGHT IS: ', windowRight);

                                    showWindows(MessageEvent.message, currentTerms[i][Object.keys(currentTerms[i])[lowercaseTerms.indexOf(MessageEvent.message.term)]], MessageEvent.message.windowWidth, MessageEvent.message.windowHeight, MessageEvent.message.windowScreenLeft, MessageEvent.message.windowScreenTop, MessageEvent.target);

                                    break;
                                }
                            }
                        }
                    }
                    break;

                case 'updateTabURL':
                    queryOptions.active = true;

                    if (windowRight !== false) {
                        queryOptions.windowId = originWindow.id
                    } else {
                        queryOptions.currentWindow = true;
                    }

                    if (typeof currentURL !== 'undefined') {
                        chrome.tabs.query(queryOptions, function(tabs) {
                            var newURL = currentURL + request.term;
                            chrome.tabs.update(tabs[0].id, {
                                url: newURL
                            });
                        });
                    }
                    break;


                default:
                    if (doLog) {
                        console.log('Message to event page was not handled: ', MessageEvent.message);
                    }
            }

            return true;
        }, false);
    </script>
</body>
